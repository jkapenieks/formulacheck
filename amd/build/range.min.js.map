{"version":3,"file":"range.min.js","sources":["../src/range.js"],"sourcesContent":["import * as Str from 'core/str';\n\nconst ensureFeedback = (el) => {\n    let fb = el.nextElementSibling;\n    if (!fb || !fb.classList.contains('invalid-feedback')) {\n        fb = document.createElement('div');\n        fb.className = 'invalid-feedback';\n        el.insertAdjacentElement('afterend', fb);\n    }\n    return fb;\n};\n\nconst boundsOf = (el) => ({\n    min: el.dataset.min !== undefined && el.dataset.min !== '' ? parseFloat(el.dataset.min) : null,\n    max: el.dataset.max !== undefined && el.dataset.max !== '' ? parseFloat(el.dataset.max) : null,\n});\n\nconst toNumber = (txt) => {\n    if (txt === null) {return NaN;}\n    const t = String(txt).trim();\n    if (!t) {return NaN;}\n    return parseFloat(t.replace(',', '.'));\n};\n\nconst message = async (state, val, min, max) => {\n    if (state === 'required') {\n        return await Str.get_string('rangejs_required', 'assignsubmission_formulacheck');\n    }\n    if (isNaN(val)) {\n        return await Str.get_string('rangejs_numeric', 'assignsubmission_formulacheck');\n    }\n    if (min !== null && max !== null && (val < min || val > max)) {\n        return await Str.get_string('rangejs_between', 'assignsubmission_formulacheck', {min, max});\n    }\n    if (min !== null && val < min) {\n        return await Str.get_string('rangejs_min', 'assignsubmission_formulacheck', min);\n    }\n    if (max !== null && val > max) {\n        return await Str.get_string('rangejs_max', 'assignsubmission_formulacheck', max);\n    }\n    return '';\n};\n\nconst mark = async (el) => {\n    const {min, max} = boundsOf(el);\n    const raw = (el.value ?? '').trim();\n    const required = raw === '';\n    const val = toNumber(raw);\n\n    let ok;\n    if (required) {\n        ok = false;\n    } else {\n        ok = !isNaN(val) && (min === null || val >= min) && (max === null || val <= max);\n    }\n\n    const fb = ensureFeedback(el);\n    el.classList.toggle('is-invalid', !ok);\n    el.classList.toggle('is-valid', ok && raw !== '');\n    el.setAttribute('aria-invalid', String(!ok));\n    fb.textContent = ok ? '' : await message(required ? 'required' : 'range', val, min, max);\n    fb.style.display = ok ? 'none' : '';\n    return ok;\n};\n\nconst validateAll = async (fields) => {\n    const results = [];\n    for (const el of fields) {results.push(await mark(el));}\n    return results.every(Boolean);\n};\n\n/**\n * Generates a random float between min (inclusive) and max (exclusive)\n * @param {number|null} min\n * @param {number|null} max\n * @returns {number}\n */\nconst randomFloat = (min, max) => {\n    // If no bounds, use a default range\n    const lower = min !== null ? min : -10;\n    const upper = max !== null ? max : 10;\n    // Simple random float in the range [lower, upper]\n    return lower + Math.random() * (upper - lower);\n};\n\n\n/**\n * Handles the click event for the random generation button.\n * @param {HTMLButtonElement} buttonEl The button element.\n */\nconst handleRandomGeneration = async (buttonEl) => {\n    // Retrieve the ranges data from the button's data attribute\n    const rangesData = JSON.parse(buttonEl.dataset.ranges || '[]');\n    // Convert array of objects to a map for easier lookup by field name\n    const rangesMap = new Map();\n    for (const data of Object.values(rangesData)) {\n        rangesMap.set(data.field_name, data);\n    }\n\n    let needsUpdate = false;\n\n    for (const [fieldName, range] of rangesMap.entries()) {\n        const inputField = document.querySelector(`input[name=\"${fieldName}\"]`);\n\n        if (inputField) {\n            // Fix: Explicitly parse min/max as floats.\n            // If the value is null or empty string, parseFloat returns NaN, which we handle by coercing to null.\n            const minVal = range.min !== null ? parseFloat(range.min) : null;\n            const maxVal = range.max !== null ? parseFloat(range.max) : null;\n\n            // Check if minVal or maxVal is NaN (if it was an invalid non-empty string)\n            // If they are NaN, they will be treated as null by randomFloat's checks.\n\n            // Generate a random number. Use two decimal places for a more \"readable\" result.\n            const randomVal = randomFloat(minVal, maxVal).toFixed(2);\n\n            // Update the input field\n            inputField.value = randomVal;\n            needsUpdate = true;\n        }\n    }\n\n    // Trigger validation and marking after filling the fields\n    if (needsUpdate) {\n        const allFields = Array.from(document.querySelectorAll('input[name^=assignsubmission_formulacheck_p]'));\n        await validateAll(allFields);\n    }\n};\n\n\n\nexport const init = async (selector) => {\n    const fields = Array.from(document.querySelectorAll(selector));\n    if (!fields.length) {return;}\n\n    const form = fields[0].closest('form');\n    //const onInput = () => { mark(this); };\n    fields.forEach(el => el.addEventListener('input', () => mark(el)));\n\n    if (form) {\n        form.addEventListener('submit', async (e) => {\n            // Only block if out-of-range or non-numeric. Required+numeric client rules also apply via QuickForm.\n            const ok = await validateAll(fields);\n            if (!ok) {\n                e.preventDefault();\n                const firstBad = fields.find(f => f.classList.contains('is-invalid'));\n                if (firstBad) {firstBad.focus();}\n            }\n        });\n    }\n\n    // New: Handle the random button click\n    const randomButton = document.getElementById(\"id_assignsubmission_formulacheck_generate_random\");\n    if (randomButton) {\n        randomButton.addEventListener('click', async (e) => {\n            e.preventDefault(); // Prevent form submission\n            await handleRandomGeneration(randomButton);\n        });\n    }\n\n    // Initial gentle pass.\n    await validateAll(fields);\n};\n"],"names":["Str","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_interopRequireWildcard","mark","async","_el$value","min","max","el","undefined","dataset","parseFloat","boundsOf","raw","value","trim","required","val","txt","NaN","String","replace","toNumber","ok","isNaN","fb","nextElementSibling","classList","contains","document","createElement","className","insertAdjacentElement","ensureFeedback","toggle","setAttribute","textContent","state","get_string","message","style","display","validateAll","results","fields","push","every","Boolean","randomFloat","lower","upper","Math","random","_exports","init","Array","from","querySelectorAll","selector","length","form","closest","forEach","addEventListener","preventDefault","firstBad","find","focus","randomButton","getElementById","rangesData","JSON","parse","buttonEl","ranges","rangesMap","Map","data","values","field_name","needsUpdate","fieldName","range","entries","inputField","querySelector","concat","minVal","maxVal","randomVal","toFixed","allFields","handleRandomGeneration"],"mappings":"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"}